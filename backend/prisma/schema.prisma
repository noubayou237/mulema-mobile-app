generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// ENUMS
// =====================

enum QuestionType {
  MATCHING
  COMPLETE_PHRASE
  LISTEN_WRITE
  LISTEN_SELECT_IMAGE
}

enum Role {
  ADMIN
  USER
}

enum OtpPurpose {
  VERIFY_EMAIL
  RESET_PASSWORD
}

// =====================
// USER & AUTH
// =====================

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  username      String   @unique
  passwordHash  String
  role          Role     @default(USER)
  isVerified    Boolean  @default(false)
  totalPrawns   Int      @default(0)

  refreshTokens RefreshToken[]
  otps          Otp[]

  statistics    Statistics?
  rootsStreak   RootsStreak?
  cowry         Cowry?
  languages     UserLanguage[]
  settings      Settings?
  avatar        Avatar?
  progress      UserProgress[]
  communities   Community[]

  officialLanguageId String?
  officialLanguage   OfficialLanguage? @relation(fields: [officialLanguageId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model RefreshToken {
  id         String   @id @default(uuid())
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Otp {
  id        String   @id @default(uuid())
  code      String
  purpose   OtpPurpose
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =====================
// USER PROFILE
// =====================

model Statistics {
  id                 String   @id @default(uuid())
  totalLearningTime  Float
  lessonsCompleted   Int
  exercisesCompleted Int
  totalPrawns        Int

  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id])
}

model RootsStreak {
  id            String   @id @default(uuid())
  daysConnected Int

  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
}

model Settings {
  id            String   @id @default(uuid())
  notifications Boolean  @default(true)
  soundEnabled  Boolean  @default(true)
  darkMode      Boolean  @default(false)

  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Avatar {
  id          String   @id @default(uuid())
  imageUrl    String
  accessoryId String?

  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =====================
// LANGUAGES
// =====================

model OfficialLanguage {
  id            String          @id @default(uuid())
  name          String

  users         User[]
  communities   Community[]
  userLanguages UserLanguage[]
}

model PatrimonialLanguage {
  id            String          @id @default(uuid())
  name          String

  stories       Story[]
  levels        Level[]
  userLanguages UserLanguage[]
}

model UserLanguage {
  id                    String               @id @default(uuid())
  userId                String
  officialLanguageId    String?
  patrimonialLanguageId String?

  user                  User                 @relation(fields: [userId], references: [id])
  officialLanguage      OfficialLanguage?    @relation(fields: [officialLanguageId], references: [id])
  patrimonialLanguage   PatrimonialLanguage? @relation(fields: [patrimonialLanguageId], references: [id])
}

// =====================
// COMMUNITY
// =====================

model Community {
  id                 String           @id @default(uuid())
  rank               Int

  officialLanguageId String
  officialLanguage   OfficialLanguage @relation(fields: [officialLanguageId], references: [id])

  users              User[]
}

// =====================
// LEARNING CONTENT
// =====================

model Story {
  id                    String              @id @default(uuid())
  patrimonialLanguageId String
  patrimonialLanguage   PatrimonialLanguage @relation(fields: [patrimonialLanguageId], references: [id])

  exercises             Exercise[] @relation("ExerciseStory")
}

model Level {
  id                    String              @id @default(uuid())
  levelNumber           Int
  title                 String?

  patrimonialLanguageId String
  patrimonialLanguage   PatrimonialLanguage @relation(fields: [patrimonialLanguageId], references: [id])

  lessons               Lesson[]
}

model Lesson {
  id           String   @id @default(uuid())
  title        String
  order        Int
  contentUrl   String?

  levelId      String
  level        Level    @relation(fields: [levelId], references: [id])

  exercises    Exercise[] @relation("ExerciseLesson")
  userProgress UserProgress[]
}

model UserProgress {
  id          String   @id @default(uuid())
  isUnlocked  Boolean  @default(false)
  isCompleted Boolean  @default(false)
  stars       Int      @default(0)

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  lessonId    String
  lesson      Lesson  @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

// =====================
// EXERCISES & SCORES
// =====================

model Exercise {
  id        String   @id @default(uuid())
  theme     String
  timeSpent Float
  accuracy  Float

  lessonId  String?
  lesson    Lesson? @relation("ExerciseLesson", fields: [lessonId], references: [id])

  storyId   String?
  story     Story?  @relation("ExerciseStory", fields: [storyId], references: [id])

  questions Question[]
  score     Score?
}

model Question {
  id            String       @id @default(uuid())
  content       String
  type          QuestionType
  correctAnswer String
  options       String[]

  exerciseId    String
  exercise      Exercise     @relation(fields: [exerciseId], references: [id])
}

model Score {
  id          String   @id @default(uuid())
  scoreValue  Int

  exerciseId  String   @unique
  exercise    Exercise @relation(fields: [exerciseId], references: [id])
}

// =====================
// GAME ECONOMY
// =====================

model Cowry {
  id             String   @id @default(uuid())
  maxCowries     Int      @default(5)
  currentCowries Int
  rechargeTime   Int

  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
}
